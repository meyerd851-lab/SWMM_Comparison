<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>SWMM Comparison App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="SWMM%20Comparison%20App%20Icon.ico">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.11.0/dist/proj4.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <header>
    <div class="menu">
      <div class="menu-btn">File</div>
      <div class="menu-content">
        <button id="saveSess" class="menu-item">Save Comparison</button>
        <button id="loadSessBtn" class="menu-item">Load Comparison</button>
        <hr>
        <button id="exportXlsx" class="menu-item">Export to Excel</button>
        <input id="loadSessInput" type="file" accept=".json" />
      </div>
    </div>

    <div class="menu">
      <div class="menu-btn">Map</div>
      <div class="menu-content">
        <label>Basemap:
          <select id="basemapSelect" title="Basemap" style="width:100%; margin-top:4px; padding: 4px;">
            <option value="street" selected>Street</option>
            <option value="aerial">Aerial</option>
            <option value="none">None</option>
          </select>
        </label>
        <hr>
        <label>Coordinate System:
          <select id="crsSelect" title="Coordinate System" style="width:100%; margin-top:4px; padding: 4px;">
            <option value="EPSG:3735" selected>NAD83 / Ohio South (ftUS)</option>
            <option value="EPSG:3733">NAD83 / Ohio North (ftUS)</option>
            <option value="EPSG:6499">NAD83 / Michigan South (ft)</option>
            <option value="EPSG:2272">NAD83 / Pennsylvania South (ftUS)</option>
          </select>
        </label>
        <hr>
        <label class="menu-item"><input type="checkbox" id="labelsToggle" checked> Show Labels</label>
      </div>
    </div>

    <button id="go" class="primary">Run Comparison</button>
    <span id="status"></span>

    <div id="app-title-group">
      <h1>SWMM Comparison App</h1>
      <img src="SWMM%20Comparison%20App%20Icon.ico" alt="App Icon">
      <button id="helpBtn" class="help-button" title="Help">?</button>
    </div>
  </header>

  <div id="wrap">
    <div id="left">
      <div id="sectionsPanel" class="panel">
        <h3>Sections</h3>
        <div id="sections">Run a comparison first.</div>
      </div>
    </div>

    <div id="v-splitter" class="splitter v-splitter"></div>

    <div id="right">
      <div class="panel" style="gap:8px;">
        <div id="filters">
          <label><input type="checkbox" id="fAdded" checked> Added</label>
          <label><input type="checkbox" id="fRemoved" checked> Removed</label>
          <label><input type="checkbox" id="fChanged" checked> Changed</label>
          <label style="margin-left: 10px; border-left: 1px solid #ddd; padding-left: 10px;">
            <input type="checkbox" id="fShowDiffs"> Show Diffs
          </label>
          <input id="search" placeholder="Filter rows…" />
          <span id="currentSectionLabel" style="color:#333;font-weight:600;"></span>
        </div>
      </div>

      <div id="detailsWrap" style="flex:1;">
        <div id="tableWrap" class="panel"
          style="display:flex; flex-direction:column; min-height:0; padding-right: 12px;">
          <h3 style="margin-bottom:8px;">Details</h3>
          <div id="tableContainer">
            <table id="table"></table>
          </div>
        </div>

        <div id="map-v-splitter" class="splitter v-splitter"></div>

        <div id="map" class="panel" style="padding-left: 12px;"></div>
      </div>
    </div>
  </div>

  <template id="legend">
    <div class="legend">
      <div class="legend-title">Map Legend</div>
      <div class="lg-item"><span class="lg-swatch lg-unchanged"></span><span>Unchanged</span></div>
      <div class="lg-item"><span class="lg-swatch lg-changed"></span><span>Changed</span></div>
      <div class="lg-item"><span class="lg-swatch lg-added"></span><span>Added</span></div>
      <div class="lg-item"><span class="lg-swatch lg-removed"></span><span>Removed</span></div>
    </div>
  </template>

  <!-- Details Modal -->
  <div id="modalBackdrop" onclick="if(event.target===this) closeModal()">
    <div id="modal" role="dialog" aria-modal="true">
      <header>
        <h2 id="modalTitle">Details</h2>
        <button onclick="closeModal()">Close</button>
      </header>
      <div class="body">
        <div id="modalMeta" style="margin-bottom:8px;color:#555;"></div>
        <div class="kv" id="modalGrid"></div>
      </div>
      <div class="foot">
        <label style="margin-right:auto">
          <input type="checkbox" id="onlyChangedBox" /> Show changed fields only
        </label>
        <button onclick="copyRowJSON()">Copy JSON</button>
      </div>
    </div>
  </div>

  <!-- Run Comparison Modal -->
  <div id="compareModalBackdrop"
    style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:10000;"
    onclick="if(event.target===this) closeCompareModal()">
    <div id="compareModal"
      style="background:#fff;border-radius:10px;border:1px solid #ddd;max-width:550px;width:90vw;display:flex;flex-direction:column;">

      <header
        style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee">
        <h2 style="margin:0;font-size:16px">Run Comparison with Tolerances</h2>
        <button onclick="closeCompareModal()">Cancel</button>
      </header>

      <div class="body" style="padding:10px 14px;overflow:auto; display: grid; grid-template-columns: 1fr; gap: 12px;">
        <h3
          style="grid-column: 1 / -1; margin: 0; font-size: 14px; border-bottom: 1px solid #eee; padding-bottom: 8px;">
          Model Files</h3>
        <div class="file-input-container">
          <label for="f1" class="file-btn-label" style="color: #222; border-color: #ccc;">First .inp</label>
          <input id="f1" type="file" accept=".inp,.txt" />
          <span id="f1-name" class="file-name-display" style="color: #555;">No file selected</span>
        </div>
        <div class="file-input-container">
          <label for="f2" class="file-btn-label" style="color: #222; border-color: #ccc;">Second .inp</label>
          <input id="f2" type="file" accept=".inp,.txt" />
          <span id="f2-name" class="file-name-display" style="color: #555;">No file selected</span>
        </div>
      </div>

      <div class="body"
        style="padding:10px 14px;overflow:auto; display: grid; grid-template-columns: 1fr 1fr; gap: 12px 20px;">
        <h3
          style="grid-column: 1 / -1; margin: 0; font-size: 14px; border-bottom: 1px solid #eee; padding-bottom: 8px;">
          Numerical Tolerances</h3>
        <p style="grid-column: 1 / -1; margin: 0 0 8px 0; font-size: 12px; color: #555;">
          Changes to the fields below will be ignored if the absolute difference is less than or equal to the specified
          tolerance.
        </p>
        <label>Conduit: Length
          <input type="number" id="tol_conduit_length" value="0" step="0.1" class="tol-input">
        </label>
        <label>Junction: Invert Elev
          <input type="number" id="tol_junction_invert" value="0" step="0.01" class="tol-input">
        </label>
        <label>Conduit: In/Out Offset
          <input type="number" id="tol_conduit_offset" value="0" step="0.01" class="tol-input">
        </label>
        <label>Junction: Max Depth
          <input type="number" id="tol_junction_depth" value="0" step="0.01" class="tol-input">
        </label>
        <label>Conduit: Roughness
          <input type="number" id="tol_conduit_roughness" value="0" step="0.001" class="tol-input">
        </label>
      </div>

      <div class="foot"
        style="display:flex;gap:8px;justify-content:flex-end;padding:10px 14px;border-top:1px solid #eee">
        <button id="runCompareFromModal" class="primary" style="min-width: 120px;">Run Comparison</button>
      </div>
    </div>
  </div>

  <!-- Help Modal -->
  <div id="helpModalBackdrop"
    style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:10000;"
    onclick="if(event.target===this) closeHelpModal()">
    <div id="helpModal"
      style="background:#fff;border-radius:10px;border:1px solid #ddd;max-width:600px;width:90vw;max-height:80vh;display:flex;flex-direction:column;">

      <header
        style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #eee">
        <h2 style="margin:0;font-size:16px">How to Use This App</h2>
        <button onclick="closeHelpModal()">Close</button>
      </header>

      <div class="body" style="padding:10px 14px;overflow:auto">
        <p>
          This application compares two SWMM <code>.inp</code> files to identify differences in their
          structure and parameters. It is still in testing and may miss edge cases, so results should
          be reviewed before use in design or modeling.
        </p>

        <ul>
          <li><strong>File:</strong> Use the <strong>File</strong> menu to save the current comparison,
            load a previous comparison, or export the differences to an Excel file.</li>

          <li><strong>Map:</strong> Use the <strong>Map</strong> menu to switch between the street and
            aerial basemaps, change the coordinate system (CRS), or toggle node/subcatchment labels on or off.</li>

          <li><strong>Run Comparison:</strong> Select your “First” and “Second” <code>.inp</code> files,
            then specify numerical tolerances to control which parameter differences are counted as
            changes.</li>

          <li><strong>Sections:</strong> The <strong>Sections</strong> panel shows a high-level count of
            added, removed, and changed elements for each SWMM section. Click a section to load a detailed
            table of changes in the <strong>Details</strong> panel.</li>

          <li><strong>Details:</strong> The <strong>Details</strong> panel shows a table of changes for
            the currently selected section.
            <ul>
              <li>Click a row to pan and zoom the map to that element and highlight it in cyan.</li>
              <li>Use the <strong>Added</strong>, <strong>Removed</strong>, and <strong>Changed</strong>
                toggles to filter which elements are shown.</li>
              <li>Use <strong>Show Diffs</strong> (where available) to show old vs. new values side-by-side
                for selected sections.</li>
              <li>Use the filter box to search for specific element IDs or parameter values within the table.</li>
              <li>Double-click a row to open a pop-up with additional detail for that change. This is
                especially used to display RTK changes in the <strong>HYDROGRAPHS</strong> section, which
                are not fully shown in the table.</li>
            </ul>
          </li>

          <li><strong>Using the Map:</strong>
            <ul>
              <li><strong>Pan and zoom:</strong> Drag to pan and use the mouse wheel or zoom controls to zoom in and
                out.
                The map automatically zooms to show all loaded geometry when a comparison is drawn.</li>
              <li><strong>Click to inspect features:</strong> Click near a node, link, or subcatchment to open a pop-up.
                The tool prioritizes nodes, then links, then subcatchments when multiple features overlap.</li>
              <li><strong>Cycle through overlapping features:</strong> If several elements are under the same click,
                use the left/right arrow buttons in the pop-up to cycle through them.</li>
              <li><strong>Highlighting:</strong> When an element is selected (from the table or the map),
                it is outlined in cyan on the map and the corresponding row is highlighted in the Details table.</li>
              <li><strong>Labels:</strong> When labels are enabled, node and subcatchment IDs appear on the map at
                higher zoom levels. Turn these on or off using the <strong>Map &gt; Labels</strong> option.</li>
              <li><strong>Legend and colors:</strong> The legend in the lower-left corner shows the color
                scheme: unchanged (gray), changed (orange), added (green), removed (red), and the cyan
                selection highlight.</li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <script type="module" src="app.js"></script>
</body>

</html>
