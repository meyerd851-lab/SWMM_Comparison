<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>SWMM Comparison App | BETA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="assets/SWMM_Comparison_Icon.png">

  <!-- External Libs -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.11.0/dist/proj4.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="styles.css" />
</head>

<body>

  <div id="app-container">

    <!-- HEADER -->
    <header>
      <div class="app-brand">
        <img src="assets/SWMM_Comparison_Icon.png" alt="App Icon">
        <h1>SWMM Comparison App</h1>
        <span class="tag">BETA</span>
      </div>

      <div class="header-actions">
        <!-- Main Actions -->
        <button id="go" class="primary">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
          Run Comparison
        </button>

        <span style="width: 1px; height: 24px; background: var(--border-medium); margin: 0 4px;"></span>

        <!-- Settings / Tools -->
        <button id="themeBtn" class="icon-btn" title="Toggle Theme">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
        </button>

        <button id="helpBtn" class="icon-btn" title="Help">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
        </button>

        <!-- File Menu Dropdown -->
        <div style="position: relative;" class="menu">
          <button class="btn">File ▼</button>
          <div class="menu-content" style="right: 0; left: auto;">
            <button id="saveSess" class="menu-item">Save Session</button>
            <button id="loadSessBtn" class="menu-item">Load Session</button>
            <hr>
            <button id="exportXlsx" class="menu-item">Export Excel</button>
            <button id="exportShp" class="menu-item">Export Shapefile</button>
            <!-- Hidden input -->
            <input id="loadSessInput" type="file" accept=".sca" style="display:none;" />
          </div>
        </div>

      </div>
    </header>

    <!-- SIDEBAR -->
    <aside id="sidebar">
      <div class="sidebar-header">
        <h3
          style="margin:0; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-tertiary);">
          Sections</h3>
      </div>
      <div id="sectionsPanel" class="sidebar-content">
        <div id="sections">
          <div style="padding: 20px; text-align: center; color: var(--text-tertiary);">
            Run a comparison to see sections.
          </div>
        </div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main id="main-content">

      <!-- Toolbar / Filters -->
      <div class="toolbar">
        <div class="filter-group">
          <label class="checkbox-label" style="color: var(--added);">
            <input type="checkbox" id="fAdded" checked> Added
          </label>
          <label class="checkbox-label" style="color: var(--removed);">
            <input type="checkbox" id="fRemoved" checked> Removed
          </label>
          <label class="checkbox-label" style="color: var(--changed);">
            <input type="checkbox" id="fChanged" checked> Changed
          </label>
          <span style="width:1px; height: 16px; background: var(--border-medium);"></span>
          <label class="checkbox-label">
            <input type="checkbox" id="fShowDiffs"> Show Differences
          </label>
        </div>

        <div class="filter-group">
          <input id="search" type="text" placeholder="Search ID..." />
          <span id="currentSectionLabel" style="font-weight: 600; color: var(--primary);"></span>

          <span id="status" style="font-size: 12px; color: var(--text-secondary); margin-left:12px;"></span>
        </div>
      </div>

      <!-- Split Layout for Table / Map -->
      <div id="detailsWrap" style="display:flex; flex:1; overflow:hidden; position:relative;">

        <!-- Table Side -->
        <div id="tableWrap" style="flex: 1; display:flex; flex-direction:column; min-width: 0;">
          <div id="table-container">
            <table id="table" class="data-table"></table>
          </div>
        </div>

        <!-- Splitter -->
        <div id="map-v-splitter" class="gutter gutter-horizontal" style="width: 6px; cursor: col-resize;"></div>

        <!-- Map Side -->
        <div id="map-wrapper"
          style="width: 45%; display:flex; flex-direction:column; min-width: 0; position: relative;">

          <div
            style="padding: 8px; border-bottom: 1px solid var(--border-light); background: var(--bg-surface); display:flex; gap: 8px; align-items: center; justify-content: space-between;">
            <span style="font-weight:600; font-size:12px;">MAP VIEW</span>

            <div style="display:flex; gap:8px;">
              <select id="crsSelect" style="padding: 4px; font-size: 11px;">
                <option value="EPSG:3735" selected>NAD83 / Ohio South (ftUS)</option>
                <option value="EPSG:3733">NAD83 / Ohio North (ftUS)</option>
                <option value="EPSG:6499">NAD83 / Michigan South (ft)</option>
                <option value="EPSG:2272">NAD83 / Pennsylvania South (ftUS)</option>
                <option value="EPSG:2284">NAD83 / Virginia South (ftUS)</option>
                <option value="EPSG:2283">NAD83 / Virginia North (ftUS)</option>
                <option value="EPSG:2248">NAD83 / Maryland (ftUS)</option>
              </select>
              <select id="mapModeSelect" style="padding: 4px; font-size: 11px;">
                <option value="Default" selected>Default View</option>
                <option value="Changed">Focus: Changed</option>
                <option value="Added">Focus: Added</option>
                <option value="Removed">Focus: Removed</option>
              </select>
              <div class="menu">
                <button class="btn"
                  style="padding: 4px; font-size: 11px; font-weight: 400; justify-content: space-between; min-width: 70px;">Labels
                  <span>▼</span></button>
                <div class="menu-content" style="right: 0; min-width: 120px;">
                  <label class="menu-item checkbox-label" style="justify-content: flex-start; cursor: pointer;">
                    <input type="checkbox" id="lblNodes" checked> Nodes
                  </label>
                  <label class="menu-item checkbox-label" style="justify-content: flex-start; cursor: pointer;">
                    <input type="checkbox" id="lblSubs"> Subcatchments
                  </label>
                  <label class="menu-item checkbox-label" style="justify-content: flex-start; cursor: pointer;">
                    <input type="checkbox" id="lblLinks"> Conduits
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div id="map" style="flex:1;"></div>


          <template id="legend">
            <div class="map-legend">
              <div style="font-weight:700; margin-bottom:8px;">Legend</div>
              <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;"><span class="dot"
                  style="background:var(--text-tertiary)"></span> Unchanged</div>
              <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;"><span
                  class="dot changed"></span> Changed</div>
              <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;"><span class="dot added"></span>
                Added</div>
              <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;"><span
                  class="dot removed"></span> Removed</div>
              <div style="display:flex; align-items:center; gap:6px; margin-bottom:4px;"><span class="dot"
                  style="background:#0ff; border:1px solid cyan;"></span> Selected</div>
            </div>
          </template>

        </div>
      </div>
    </main>
  </div>

  <!-- MODALS -->

  <!-- Run Comparison Modal -->
  <div id="compareModalBackdrop" class="modal-backdrop">
    <div id="compareModal" class="modal-content">
      <div class="modal-header">
        <h2>Run Comparison</h2>
        <button class="icon-btn" onclick="closeCompareModal()">✕</button>
      </div>
      <div class="modal-body">

        <h3 style="font-size:14px; margin-bottom:12px;">Select Input Files</h3>
        <div style="display:grid; gap:16px; margin-bottom:24px;">
          <div style="border: 1px dashed var(--border-medium); padding: 16px; border-radius: 8px; text-align: center;">
            <label for="f1" class="btn">Choose First .inp</label>
            <input id="f1" type="file" accept=".inp,.txt" style="display:none" />
            <div id="f1-name" style="margin-top:8px; font-size:12px; color:var(--text-secondary);">No file selected
            </div>
          </div>

          <div style="border: 1px dashed var(--border-medium); padding: 16px; border-radius: 8px; text-align: center;">
            <label for="f2" class="btn">Choose Second .inp</label>
            <input id="f2" type="file" accept=".inp,.txt" style="display:none" />
            <div id="f2-name" style="margin-top:8px; font-size:12px; color:var(--text-secondary);">No file selected
            </div>
          </div>
        </div>

        <button id="toggleTolerances" class="btn"
          style="width:100%; justify-content:space-between; margin-bottom:12px;">
          <span>Tolerance Options</span>
          <span id="tolArrow">▶</span>
        </button>

        <div id="toleranceOptions" style="display:none; grid-template-columns: 1fr 1fr; gap: 12px;">
          <label class="flex-col gap-2">Conduit Length <input type="number" id="tol_conduit_length" value="0"
              step="0.1"></label>
          <label class="flex-col gap-2">Junc Invert <input type="number" id="tol_junction_invert" value="0"
              step="0.01"></label>
          <label class="flex-col gap-2">Conduit Offset <input type="number" id="tol_conduit_offset" value="0"
              step="0.01"></label>
          <label class="flex-col gap-2">Junc Max Depth <input type="number" id="tol_junction_depth" value="0"
              step="0.01"></label>
          <label class="flex-col gap-2">Roughness <input type="number" id="tol_conduit_roughness" value="0"
              step="0.001"></label>
        </div>

      </div>
      <div class="modal-footer">
        <button onclick="closeCompareModal()">Cancel</button>
        <button id="runCompareFromModal" class="primary">Compare Files</button>
      </div>
    </div>
  </div>

  <!-- Details Modal -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div id="modal" class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Details</h2>
        <button class="icon-btn" onclick="closeModal()">✕</button>
      </div>
      <div class="modal-body">
        <div id="modalMeta" style="margin-bottom:16px;"></div>
        <div class="kv" id="modalGrid"
          style="display: grid; grid-template-columns: 140px 1fr 1fr; gap: 1px; background: var(--border-medium); border: 1px solid var(--border-medium);">
          <!-- Cell content injected by JS -->
        </div>
      </div>
      <div class="modal-footer">
        <label style="margin-right:auto; display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="onlyChangedBox" /> Only show changed
        </label>
        <button onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Help Modal -->
  <div id="helpModalBackdrop" class="modal-backdrop">
    <div id="helpModal" class="modal-content">
      <div class="modal-header">
        <h2>Help</h2>
        <button class="icon-btn" onclick="closeHelpModal()">✕</button>
      </div>
      <div class="modal-body">
        <div style="line-height: 1.6;">
          <h3 style="font-size:14px; margin-bottom:8px; color:var(--primary);">1. Getting Started</h3>
          <ul style="margin:0 0 16px 0; padding-left:20px;">
            <li>Click <strong>Run Comparison</strong> to open the setup dialog.</li>
            <li>Select two input files (<strong>.inp</strong> or <strong>.txt</strong>).</li>
            <li>(Optional) Expand <strong>Tolerance Options</strong> to ignore minor differences.</li>
            <li>Click <strong>Compare Files</strong> to generate the report.</li>
          </ul>

          <h3 style="font-size:14px; margin-bottom:8px; color:var(--primary);">2. Navigating Results</h3>
          <ul style="margin:0 0 16px 0; padding-left:20px;">
            <li>Use the <strong>Sections</strong> sidebar to switch between data tables (e.g., Junctions, Conduits).
            </li>
            <li><strong>Filter Buttons</strong> (top toolbar) show/hide Added, Removed, or Changed items.</li>
            <li>Use the <strong>Search</strong> bar to find specific element IDs.</li>
            <li><strong>Double-click</strong> any row (or click the <strong>Details</strong> icon) to see a full
              field-by-field comparison.</li>
          </ul>

          <h3 style="font-size:14px; margin-bottom:8px; color:var(--primary);">3. Using the Map</h3>
          <ul style="margin:0 0 16px 0; padding-left:20px;">
            <li>Elements are colored by status: <span style="color:var(--added); font-weight:600;">Green (Added)</span>,
              <span style="color:var(--removed); font-weight:600;">Red (Removed)</span>, <span
                style="color:var(--changed); font-weight:600;">Orange (Changed)</span>.
            </li>
            <li>Use the <strong>Map View Mode</strong> dropdown (top of map) to focus on specific changes.</li>
            <li><strong>Click</strong> an element on the map to see its status and changes popup.</li>
            <li>Toggle <strong>Labels</strong> to see element IDs at high zoom levels.</li>
          </ul>

          <h3 style="font-size:14px; margin-bottom:8px; color:var(--primary);">4. Export & Save</h3>
          <ul style="margin:0 0 16px 0; padding-left:20px;">
            <li><strong>File > Save Session:</strong> Saves your current comparison to a <code>.sca</code> file to
              reload later.</li>
            <li><strong>File > Export Excel:</strong> Downloads a detailed .xlsx report of all differences.</li>
            <li><strong>File > Export Shapefile:</strong> Generates GIS files for the added/removed/changed elements.
            </li>
          </ul>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="closeHelpModal()">Close</button>
      </div>
    </div>
  </div>

  <script type="module" src="js/app.js"></script>
</body>

</html>